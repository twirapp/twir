name: Build and lint

on:
  push:
    branches-ignore:
      - main
  workflow_dispatch:

concurrency:
  group: pr-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: false

jobs:
  build-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: Install JavaScript dependencies
        if: ${{ matrix.folders.runtime == 'js' && env.run-build == 'true' }}
        run: bun install --frozen-lockfile

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ./go.work
          cache-dependency-path: |
            go.work.sum
            **/go.sum

      - name: Install go dependencies
        run: bun cli deps

      - name: Build
        run: bun cli build

      - name: Lint
        run: bun lint
