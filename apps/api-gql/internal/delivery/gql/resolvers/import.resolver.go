package resolvers

// This file will be automatically regenerated based on the schema, any resolver
// implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.84

import (
	"context"

	"github.com/twirapp/twir/apps/api-gql/internal/delivery/gql/gqlmodel"
	"github.com/twirapp/twir/apps/api-gql/internal/delivery/gql/mappers"
)

// NightbotPostCode is the resolver for the nightbotPostCode field.
func (r *mutationResolver) NightbotPostCode(ctx context.Context, input gqlmodel.NightbotPostCodeInput) (bool, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return false, err
	}

	err = r.deps.NightbotIntegrationService.PostCode(ctx, dashboardId, input.Code)
	if err != nil {
		return false, err
	}

	return true, nil
}

// NightbotLogout is the resolver for the nightbotLogout field.
func (r *mutationResolver) NightbotLogout(ctx context.Context) (bool, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return false, err
	}

	err = r.deps.NightbotIntegrationService.Logout(ctx, dashboardId)
	if err != nil {
		return false, err
	}

	return true, nil
}

// NightbotImportCommands is the resolver for the nightbotImportCommands field.
func (r *mutationResolver) NightbotImportCommands(ctx context.Context) (*gqlmodel.NightbotImportCommandsOutput, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return nil, err
	}

	user, err := r.deps.Sessions.GetAuthenticatedUserModel(ctx)
	if err != nil {
		return nil, err
	}

	result, err := r.deps.NightbotIntegrationService.ImportCommands(ctx, dashboardId, user.ID)
	if err != nil {
		return nil, err
	}

	return &gqlmodel.NightbotImportCommandsOutput{
		ImportedCount:       result.ImportedCount,
		FailedCount:         result.FailedCount,
		FailedCommandsNames: result.FailedCommandsNames,
	}, nil
}

// NightbotImportTimers is the resolver for the nightbotImportTimers field.
func (r *mutationResolver) NightbotImportTimers(ctx context.Context) (*gqlmodel.NightbotImportTimersOutput, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return nil, err
	}

	user, err := r.deps.Sessions.GetAuthenticatedUserModel(ctx)
	if err != nil {
		return nil, err
	}

	result, err := r.deps.NightbotIntegrationService.ImportTimers(ctx, dashboardId, user.ID)
	if err != nil {
		return nil, err
	}

	return &gqlmodel.NightbotImportTimersOutput{
		ImportedCount:     result.ImportedCount,
		FailedCount:       result.FailedCount,
		FailedTimersNames: result.FailedTimersNames,
	}, nil
}

// StreamelementsGetAuthorizationURL is the resolver for the streamelementsGetAuthorizationUrl field.
func (r *queryResolver) StreamelementsGetAuthorizationURL(ctx context.Context) (string, error) {
	link, err := r.deps.StreamElementsService.GetAuthLink()
	if err != nil {
		return "", err
	}

	return link, nil
}

// StreamelementsExchangeDataByCode is the resolver for the streamelementsExchangeDataByCode field.
func (r *queryResolver) StreamelementsExchangeDataByCode(ctx context.Context, code string) (*gqlmodel.StreamElementsImportDataOutput, error) {
	data, err := r.deps.StreamElementsService.ExchangeDataByCode(ctx, code)
	if err != nil {
		return nil, err
	}

	convertedCommands := make([]gqlmodel.StreamElementsCommand, 0, len(data.Commands))
	convertedTimers := make([]gqlmodel.StreamElementsTimer, 0, len(data.Timers))

	for _, cmd := range data.Commands {
		convertedCommands = append(convertedCommands, mappers.StreamElementsCommandToGql(cmd))
	}

	for _, timer := range data.Timers {
		convertedTimers = append(convertedTimers, mappers.StreamElementsTimerToGql(timer))
	}

	return &gqlmodel.StreamElementsImportDataOutput{
		Commands: convertedCommands,
		Timers:   convertedTimers,
	}, nil
}

// NightbotGetAuthLink is the resolver for the nightbotGetAuthLink field.
func (r *queryResolver) NightbotGetAuthLink(ctx context.Context) (string, error) {
	link, err := r.deps.NightbotIntegrationService.GetAuthLink(ctx)
	if err != nil {
		return "", err
	}

	return link, nil
}

// NightbotGetData is the resolver for the nightbotGetData field.
func (r *queryResolver) NightbotGetData(ctx context.Context) (*gqlmodel.NightbotIntegration, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return nil, err
	}

	data, err := r.deps.NightbotIntegrationService.GetData(ctx, dashboardId)
	if err != nil {
		return nil, err
	}

	if data == nil {
		return nil, nil
	}

	return &gqlmodel.NightbotIntegration{
		UserName: data.UserName,
		Avatar:   data.Avatar,
	}, nil
}
