package resolvers

// This file will be automatically regenerated based on the schema, any resolver
// implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.84

import (
	"context"

	"github.com/google/uuid"
	"github.com/twirapp/twir/apps/api-gql/internal/delivery/gql/gqlmodel"
	"github.com/twirapp/twir/apps/api-gql/internal/delivery/gql/mappers"
	"github.com/twirapp/twir/apps/api-gql/internal/entity"
	"github.com/twirapp/twir/apps/api-gql/internal/services/channels_overlays"
)

// ChannelOverlayCreate is the resolver for the channelOverlayCreate field.
func (r *mutationResolver) ChannelOverlayCreate(ctx context.Context, input gqlmodel.ChannelOverlayCreateInput) (*gqlmodel.ChannelOverlay, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return nil, err
	}

	user, err := r.deps.Sessions.GetAuthenticatedUserModel(ctx)
	if err != nil {
		return nil, err
	}

	layers := make([]channels_overlays.CreateLayerInput, len(input.Layers))
	for i, l := range input.Layers {
		layers[i] = channels_overlays.CreateLayerInput{
			Type: mappers.ChannelOverlayLayerTypeGqlToEntity(l.Type),
			Settings: entity.ChannelOverlayLayerSettings{
				HtmlOverlayHTML:                    l.Settings.HTMLOverlayHTML,
				HtmlOverlayCSS:                     l.Settings.HTMLOverlayCSS,
				HtmlOverlayJS:                      l.Settings.HTMLOverlayJs,
				HtmlOverlayDataPollSecondsInterval: l.Settings.HTMLOverlayDataPollSecondsInterval,
			},
			PosX:                    l.PosX,
			PosY:                    l.PosY,
			Width:                   l.Width,
			Height:                  l.Height,
			Rotation:                l.Rotation,
			PeriodicallyRefetchData: l.PeriodicallyRefetchData,
		}
	}

	overlay, err := r.deps.ChannelOverlaysService.Create(
		ctx,
		channels_overlays.CreateInput{
			ChannelID: dashboardId,
			ActorID:   user.ID,
			Name:      input.Name,
			Width:     input.Width,
			Height:    input.Height,
			Layers:    layers,
		},
	)
	if err != nil {
		return nil, err
	}

	converted := mappers.ChannelOverlayEntityToGql(overlay)
	return &converted, nil
}

// ChannelOverlayUpdate is the resolver for the channelOverlayUpdate field.
func (r *mutationResolver) ChannelOverlayUpdate(ctx context.Context, id uuid.UUID, input gqlmodel.ChannelOverlayUpdateInput) (*gqlmodel.ChannelOverlay, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return nil, err
	}

	user, err := r.deps.Sessions.GetAuthenticatedUserModel(ctx)
	if err != nil {
		return nil, err
	}

	layers := make([]channels_overlays.CreateLayerInput, len(input.Layers))
	for i, l := range input.Layers {
		layers[i] = channels_overlays.CreateLayerInput{
			Type: mappers.ChannelOverlayLayerTypeGqlToEntity(l.Type),
			Settings: entity.ChannelOverlayLayerSettings{
				HtmlOverlayHTML:                    l.Settings.HTMLOverlayHTML,
				HtmlOverlayCSS:                     l.Settings.HTMLOverlayCSS,
				HtmlOverlayJS:                      l.Settings.HTMLOverlayJs,
				HtmlOverlayDataPollSecondsInterval: l.Settings.HTMLOverlayDataPollSecondsInterval,
			},
			PosX:                    l.PosX,
			PosY:                    l.PosY,
			Width:                   l.Width,
			Height:                  l.Height,
			Rotation:                l.Rotation,
			PeriodicallyRefetchData: l.PeriodicallyRefetchData,
		}
	}

	overlay, err := r.deps.ChannelOverlaysService.Update(
		ctx,
		id,
		channels_overlays.UpdateInput{
			ChannelID: dashboardId,
			ActorID:   user.ID,
			Name:      input.Name,
			Width:     input.Width,
			Height:    input.Height,
			Layers:    layers,
		},
	)
	if err != nil {
		return nil, err
	}

	converted := mappers.ChannelOverlayEntityToGql(overlay)
	return &converted, nil
}

// ChannelOverlayDelete is the resolver for the channelOverlayDelete field.
func (r *mutationResolver) ChannelOverlayDelete(ctx context.Context, id uuid.UUID) (bool, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return false, err
	}

	user, err := r.deps.Sessions.GetAuthenticatedUserModel(ctx)
	if err != nil {
		return false, err
	}

	err = r.deps.ChannelOverlaysService.Delete(ctx, id, dashboardId, user.ID)
	if err != nil {
		return false, err
	}

	return true, nil
}

// ChannelOverlayParseHTML is the resolver for the channelOverlayParseHtml field.
func (r *mutationResolver) ChannelOverlayParseHTML(ctx context.Context, html string) (string, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return "", err
	}

	result, err := r.deps.ChannelOverlaysService.ParseHtml(
		ctx,
		channels_overlays.ParseHtmlInput{
			ChannelID: dashboardId,
			Html:      html,
		},
	)
	if err != nil {
		return "", err
	}

	return result, nil
}

// ChannelOverlays is the resolver for the channelOverlays field.
func (r *queryResolver) ChannelOverlays(ctx context.Context) ([]gqlmodel.ChannelOverlay, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return nil, err
	}

	overlays, err := r.deps.ChannelOverlaysService.GetManyByChannelID(ctx, dashboardId)
	if err != nil {
		return nil, err
	}

	result := make([]gqlmodel.ChannelOverlay, len(overlays))
	for i, o := range overlays {
		result[i] = mappers.ChannelOverlayEntityToGql(o)
	}

	return result, nil
}

// ChannelOverlayByID is the resolver for the channelOverlayById field.
func (r *queryResolver) ChannelOverlayByID(ctx context.Context, id uuid.UUID) (*gqlmodel.ChannelOverlay, error) {
	dashboardId, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if err != nil {
		return nil, err
	}

	overlay, err := r.deps.ChannelOverlaysService.GetByID(ctx, id)
	if err != nil {
		return nil, err
	}

	if overlay.ChannelID != dashboardId {
		return nil, nil
	}

	converted := mappers.ChannelOverlayEntityToGql(overlay)
	return &converted, nil
}
