package resolvers

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.76

import (
	"context"

	"github.com/samber/lo"
	data_loader "github.com/twirapp/twir/apps/api-gql/internal/delivery/gql/dataloader"
	"github.com/twirapp/twir/apps/api-gql/internal/delivery/gql/gqlmodel"
	"github.com/twirapp/twir/apps/api-gql/internal/delivery/gql/graph"
	"github.com/twirapp/twir/apps/api-gql/internal/entity"
	tts_mapper "github.com/twirapp/twir/apps/api-gql/internal/gql/mappers"
	"github.com/twirapp/twir/apps/api-gql/internal/services/modules_tts"
)

// ModulesTtsUpdate is the resolver for the modulesTtsUpdate field.
func (r *mutationResolver) ModulesTtsUpdate(ctx context.Context, input gqlmodel.TtsSettingsInput) (*gqlmodel.TtsSettings, error) {
	dashboardID, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if dashboardID == "" {
		return nil, err
	}

	var enabled *bool
	if input.Enabled.IsSet() {
		enabled = input.Enabled.Value()
	}

	settings, err := r.deps.ModulesTtsService.UpdateSettings(
		ctx,
		modules_tts.UpdateSettingsInput{
			ChannelID:                          dashboardID,
			Enabled:                            enabled,
			Rate:                               input.Rate,
			Volume:                             input.Volume,
			Pitch:                              input.Pitch,
			Voice:                              input.Voice,
			AllowUsersChooseVoiceInMainCommand: input.AllowUsersChooseVoiceInMainCommand,
			MaxSymbols:                         input.MaxSymbols,
			DisallowedVoices:                   input.DisallowedVoices,
			DoNotReadEmoji:                     input.DoNotReadEmoji,
			DoNotReadTwitchEmotes:              input.DoNotReadTwitchEmotes,
			DoNotReadLinks:                     input.DoNotReadLinks,
			ReadChatMessages:                   input.ReadChatMessages,
			ReadChatMessagesNicknames:          input.ReadChatMessagesNicknames,
		},
	)
	if err != nil {
		return nil, err
	}

	return tts_mapper.EntityToGql(settings), nil
}

// ModulesTtsUsersDelete is the resolver for the modulesTtsUsersDelete field.
func (r *mutationResolver) ModulesTtsUsersDelete(ctx context.Context, userIds []string) (bool, error) {
	dashboardID, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if dashboardID == "" {
		return false, err
	}

	err = r.deps.ModulesTtsService.DeleteUsers(
		ctx,
		modules_tts.DeleteUsersInput{
			ChannelID: dashboardID,
			UserIDs:   userIds,
		},
	)
	if err != nil {
		return false, err
	}

	return true, nil
}

// ModulesTts is the resolver for the modulesTts field.
func (r *queryResolver) ModulesTts(ctx context.Context) (*gqlmodel.TtsSettings, error) {
	dashboardID, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if dashboardID == "" {
		return nil, err
	}

	settings, err := r.deps.ModulesTtsService.GetSettings(
		ctx,
		modules_tts.GetSettingsInput{
			ChannelID: dashboardID,
		},
	)
	if err != nil {
		return nil, err
	}

	return tts_mapper.EntityToGql(settings), nil
}

// ModulesTtsUsersSettings is the resolver for the modulesTtsUsersSettings field.
func (r *queryResolver) ModulesTtsUsersSettings(ctx context.Context) ([]gqlmodel.TtsUserSettings, error) {
	dashboardID, err := r.deps.Sessions.GetSelectedDashboard(ctx)
	if dashboardID == "" {
		return nil, err
	}

	usersSettings, err := r.deps.ModulesTtsService.GetUsersSettings(
		ctx,
		modules_tts.GetUserSettingsInput{
			ChannelID: dashboardID,
		},
	)
	if err != nil {
		return nil, err
	}

	return lo.FilterMap(
		usersSettings,
		func(s entity.TtsSettings, _ int) (gqlmodel.TtsUserSettings, bool) {
			result := tts_mapper.EntityToUserGql(s)
			if result == nil {
				return gqlmodel.TtsUserSettings{}, false
			}
			return *result, true
		},
	), nil
}

// User is the resolver for the user field.
func (r *ttsUserSettingsResolver) User(ctx context.Context, obj *gqlmodel.TtsUserSettings) (*gqlmodel.TwirUserTwitchInfo, error) {
	return data_loader.GetHelixUserById(ctx, obj.UserID)
}

// TtsUserSettings returns graph.TtsUserSettingsResolver implementation.
func (r *Resolver) TtsUserSettings() graph.TtsUserSettingsResolver {
	return &ttsUserSettingsResolver{r}
}

type ttsUserSettingsResolver struct{ *Resolver }
